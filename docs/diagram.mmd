%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e1f5fe', 'primaryTextColor': '#01579b', 'primaryBorderColor': '#0288d1', 'lineColor': '#0288d1', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#f3e5f5'}}}%%

flowchart TB
    %% ============================================================
    %% STEM DOMAIN ANALYSIS - HYBRID PIPELINE WORKFLOW (--hybrid)
    %% ============================================================
    %% 9-stage pipeline with two-branch preprocessing,
    %% two-tier SNR classification, quality gates G0-G12,
    %% unified low-q / DC exclusion (effective_q_min),
    %% PhysicsConfig (d-range, Nyquist guard),
    %% and 32 output artifacts (8 data + 24 PNG).
    %% ============================================================

    subgraph INPUT["1/9 INPUT VALIDATION"]
        direction TB
        IN_FILE["Input File<br/>.dm4 / .dm3 / .tiff / .npy"]
        IN_META["Metadata Extraction<br/>(pixel_size_nm)"]
        IN_GRID["FFTGrid Construction<br/>(canonical cycles/nm coords)"]
        IN_QMIN["Compute effective_q_min<br/>(global + tile grids)<br/><i>--q-min override, --no-low-q-exclusion</i>"]
        IN_PHYSICS["PhysicsConfig<br/>(d_min, d_max, imaging_mode)<br/><i>--physics-d-min, --physics-d-max</i>"]
        IN_G0{{"Gate G0: Nyquist Guard<br/>q_max < 0.95 × q_nyquist<br/><b>DEGRADE: auto-clamp q-range</b><br/><b>FATAL: entire band invalid</b>"}}
        IN_G1{{"Gate G1: Input Validation<br/>2D, no NaN/Inf, >=512x512<br/><b>FATAL on failure</b>"}}
        IN_FILE --> IN_META --> IN_GRID --> IN_QMIN --> IN_PHYSICS --> IN_G0 --> IN_G1
    end

    subgraph PREPROCESS["2-3/9 TWO-BRANCH PREPROCESSING"]
        direction TB

        subgraph BRANCH_A["Branch A: FFT-Safe (no blur)"]
            direction TB
            PA_HOT["<b>Hot Pixel Removal</b><br/>Median 3x3 filter<br/>sigma=5.0 x local MAD<br/><i>Preserves periodicity</i>"]
            PA_CLIP["<b>Outlier Clipping</b><br/>Percentile p0.1 - p99.9<br/><i>Removes intensity extremes</i>"]
            PA_NORM["<b>Robust Normalization</b><br/>(img - median) / (1.4826 x MAD)<br/>Clip [-5, 5] -> [0, 1]<br/><i>Falls back to min-max if G2 fails</i>"]
            PA_G2{{"Gate G2: Preproc Quality<br/>clipped < 0.5%, range_ratio > 10<br/><b>DEGRADE on failure</b>"}}
            PA_HOT --> PA_CLIP --> PA_NORM --> PA_G2
        end

        subgraph BRANCH_B["Branch B: Segmentation (blurred)"]
            direction TB
            PB_CLIP["<b>Outlier Clipping</b><br/>Percentile p0.1 - p99.9"]
            PB_NORM["<b>Min-Max Normalization</b><br/>Scale to [0, 1]"]
            PB_GAUSS["<b>Gaussian Smoothing</b><br/>sigma = 0.5<br/><i>For ROI detection only</i>"]
            PB_CLIP --> PB_NORM --> PB_GAUSS
        end
    end

    subgraph ROI["4/9 EARLY ROI MASKING"]
        direction TB

        subgraph ROI_FEATURES["Feature Masks"]
            ROI_INT["<b>Intensity Mask</b><br/>Percentile 10 threshold<br/><i>Exclude dark background</i>"]
            ROI_VAR["<b>Variance Mask</b><br/>32x32 local variance<br/>Percentile 20 threshold<br/><i>Exclude smooth regions</i>"]
        end

        ROI_COMBINE["Combined Mask<br/>(intensity AND variance)"]
        ROI_INT & ROI_VAR --> ROI_COMBINE

        subgraph ROI_MORPH["Morphological Cleanup"]
            ROI_FILL["<b>Binary Fill Holes</b>"]
            ROI_OPEN["<b>Binary Opening</b><br/>5x5 kernel"]
            ROI_SMOOTH["<b>Gaussian Smooth</b><br/>sigma=2.0, threshold 0.5"]
        end

        ROI_COMBINE --> ROI_FILL --> ROI_OPEN --> ROI_SMOOTH

        ROI_TILE["Downsample to Tile Grid<br/>(tile coverage >= 50%)"]
        ROI_GRAD["<b>Gradient Fallback</b><br/>Sobel magnitude if coverage<br/>or LCC fraction fails"]
        ROI_G3{{"Gate G3: ROI Geometry<br/>coverage in [10%, 95%]<br/>lcc_fraction >= 0.5<br/>fragments <= 20<br/><b>FALLBACK: full-image ROI</b>"}}
        ROI_SMOOTH --> ROI_TILE --> ROI_GRAD --> ROI_G3
    end

    subgraph GLOBAL_FFT["5/9 GLOBAL FFT ANALYSIS"]
        direction TB

        subgraph GFFT_PREP["FFT Preparation"]
            GF_CROP["Centre Crop<br/>(max 4096x4096, power-of-2)"]
            GF_HANN["<b>Hann Window</b><br/>2D outer product<br/><i>Reduces spectral leakage</i>"]
            GF_FFT["2D FFT + Shift<br/>(GPU or CPU path)"]
            GF_POWER["|FFT|^2 Power Spectrum"]
        end

        GF_CROP --> GF_HANN --> GF_FFT --> GF_POWER

        subgraph GFFT_RADIAL["Radial Profile Analysis"]
            GF_RADIAL["<b>Radial Binning</b><br/>Azimuthal averaging"]
            GF_POLY["<b>Polynomial Background</b><br/>Degree 3 (cap 4), log-space<br/>q_fit_min constraint<br/>4× MAD reweighting<br/><i>Fit excludes q < max(q_min, q_fit_min)</i>"]
            GF_NOISE["<b>Noise Floor</b><br/>MAD x 1.4826 of residuals"]
            GF_SAVGOL["<b>Savitzky-Golay Smooth</b><br/>window=11, polyorder=2"]
        end

        GF_POWER --> GF_RADIAL --> GF_POLY --> GF_NOISE --> GF_SAVGOL

        GF_PEAKS["Radial Peak Detection<br/>(prominence + SNR)"]
        GF_GUIDANCE["FFT Guidance Strength<br/>(strong / weak / none)<br/><i>Controls GPA eligibility</i>"]
        GF_DIAG["Background Diagnostics<br/>(median|res|, MAD, neg-excursion)"]
        GF_SAVGOL --> GF_PEAKS
        GF_PEAKS --> GF_GUIDANCE
        GF_PEAKS --> GF_DIAG

        subgraph GFFT_GVEC["G-Vector Extraction"]
            GF_RING["Multi-Ring Polar Resampling<br/>(up to 8 radial peaks)"]
            GF_ANGULAR["Angular Peak Detection<br/>+ FWHM-Scaled Antipodal Pairing"]
            GF_DEDUP["Harmonic De-duplication"]
            GF_TOPK["Top-K Non-Collinear Selection<br/>(max 6, >15 deg separation)"]
        end

        GF_PEAKS --> GF_RING --> GF_ANGULAR --> GF_DEDUP --> GF_TOPK

        GF_G4{{"Gate G4: FFT Viability<br/>best_peak_snr >= 3.0<br/><b>FALLBACK: no global guidance</b>"}}
        GF_TOPK --> GF_G4
    end

    subgraph TILE_FFT["6/9 TILE FFT + TWO-TIER CLASSIFICATION"]
        direction TB

        TF_G5{{"Gate G5: Tiling Adequacy<br/>periods = tile_size / d_px >= 20<br/><b>FATAL on failure</b>"}}

        subgraph TF_PERTILE["Per-Tile FFT Processing"]
            TF_EXTRACT["Tile Extraction<br/>(256x256, stride 128)"]
            TF_HANN["<b>Hann Window</b><br/>2D outer product"]
            TF_FFT["2D FFT + Shift<br/>(batched GPU or sequential CPU)"]
            TF_DC["<b>Unified DC Masking</b><br/>q_dc_min = max(q_min, config.q_dc_min)<br/><i>Single q-based code path</i>"]
            TF_QMASK["Q-range Filtering<br/>(seeded from global FFT)"]
            TF_LOCALMAX["<b>Local Max Detection</b><br/>5x5 footprint<br/><b>SNR-first filtering</b><br/>(annular SNR >= 2.5)"]
            TF_SUBPX["Subpixel Refinement<br/>(parabolic interpolation)"]
        end

        TF_G5 --> TF_EXTRACT --> TF_HANN --> TF_FFT --> TF_DC --> TF_QMASK --> TF_LOCALMAX --> TF_SUBPX

        subgraph TF_CLASS["Two-Tier Classification"]
            TF_SNR["<b>Peak SNR Computation</b><br/>Signal disk r=3px<br/>Background annulus at |q|<br/>Annulus guarded: q >= q_min<br/>MAD-based noise: sigma = MAD x 1.4826<br/>SNR = (peak - median) / sigma"]
            TF_FWHM["<b>Two-Stage FWHM</b><br/>All peaks: moment proxy (fast)<br/>Top-K high-SNR: curve_fit (accurate)<br/><i>FWHMConfig: auto mode, K=2</i>"]
            TF_SYM["Pair Fraction Check<br/>(+/-g pairing, FWHM-scaled tol)"]
            TF_NONCOL["Non-Collinear Count<br/>(>15 deg separation)"]
            TF_ORIENT["Orientation Confidence<br/>(circular concentration R)"]
            TF_TIER["Tier Assignment<br/>A: SNR>=5.0 + pair_frac>=0.3 + noncol>=2<br/>B: SNR>=3.0<br/>REJECTED: SNR<3.0"]
        end

        TF_SUBPX --> TF_SNR --> TF_FWHM --> TF_SYM --> TF_NONCOL --> TF_ORIENT --> TF_TIER

        subgraph TF_AGGREGATE["Grid Aggregation"]
            TF_MAPS["Build Maps<br/>(tier, SNR, pair_fraction, FWHM,<br/>orientation, orientation_confidence)"]
            TF_G6{{"Gate G6: Detection Rate<br/>tier_a_fraction >= 5%<br/><b>DEGRADE on failure</b>"}}
            TF_G7{{"Gate G7: SNR Quality<br/>median_snr_tier_a >= 5.0<br/><b>DEGRADE on failure</b>"}}
            TF_G8{{"Gate G8: Pair Fraction<br/>mean_pair_fraction_tier_a >= 0.3<br/><b>DEGRADE on failure</b>"}}
        end

        TF_TIER --> TF_MAPS --> TF_G6 --> TF_G7 --> TF_G8
    end

    subgraph GPA["7/9 GPA (optional, --no-gpa to skip)"]
        direction TB

        GPA_ENTRY{{"Entry Gate<br/>Skip if guidance='none'<br/>or tier_a_fraction < 10%"}}
        GPA_MODE["Mode Selection<br/>(auto / full / region)"]

        GPA_ENTRY --> GPA_MODE

        subgraph GPA_REF["Reference Region Selection"]
            GPA_CC["Connected Components<br/>of Tier A tiles"]
            GPA_SCORE["Region Scoring<br/>0.4*(1-entropy) + 0.3*snr + 0.3*area"]
            GPA_G9{{"Gate G9: Reference Quality<br/>area>=9, entropy<=0.3, SNR>=5.0<br/><b>SKIP_STAGE on failure</b>"}}
        end

        GPA_MODE --> GPA_CC --> GPA_SCORE --> GPA_G9

        subgraph GPA_PHASE["Phase Extraction (per g-vector)"]
            GPA_GMASK["<b>Gaussian Mask</b><br/>Centered on g-peak<br/>sigma = median(FWHM)<br/><i>DC clamp: sigma <= 0.18 x min|g|</i>"]
            GPA_FILTER["Filtered FFT Component<br/>FT_shifted x mask"]
            GPA_DEMOD["<b>Subpixel Demodulation</b><br/>Phase ramp removal<br/>exp(-2j*pi*(gx*x + gy*y))"]
            GPA_UNWRAP["<b>Phase Unwrapping</b><br/>skimage.restoration<br/><i>Zeroed outside amp mask<br/>NaN after unwrap</i>"]
            GPA_AMPMASK["<b>Amplitude Masking</b><br/>Threshold + 2x erosion"]
        end

        GPA_G9 --> GPA_GMASK --> GPA_FILTER --> GPA_DEMOD --> GPA_UNWRAP --> GPA_AMPMASK

        GPA_G10{{"Gate G10: Phase Noise<br/>sigma_phi<=0.3 rad<br/>ref-region unwrap>=70%<br/><b>SKIP_STAGE on failure</b>"}}
        GPA_AMPMASK --> GPA_G10

        subgraph GPA_STRAIN["Displacement & Strain"]
            GPA_DISP["Displacement Field<br/>ux, uy from 2 g-vectors (nm)"]
            GPA_SMOOTH["<b>Gaussian Smoothing</b><br/>sigma=2.0"]
            GPA_STRAIN_COMP["Strain Field<br/>(exx, eyy, exy, rotation)"]
        end

        GPA_G10 --> GPA_DISP --> GPA_SMOOTH --> GPA_STRAIN_COMP

        GPA_G11{{"Gate G11: Strain Sanity<br/>|ref_strain|<=0.005<br/>outlier_fraction<=20%<br/><b>SKIP_STAGE on failure</b>"}}
        GPA_STRAIN_COMP --> GPA_G11
    end

    subgraph PEAKFIND["8/9 PEAK FINDING (optional, --no-peak-finding to skip)"]
        direction TB

        subgraph PF_BANDPASS["Bandpass Filtering"]
            PF_RING["<b>Directional Mask in FFT Space</b><br/>±g angular wedges (±30° half-width)<br/>bandwidth +/-30%<br/>Cosine taper at edges<br/><i>Zeroed below q_min<br/>Fallback: full ring if no g-vectors</i>"]
            PF_IFFT["Inverse FFT<br/>(filtered real-space image)"]
        end

        PF_RING --> PF_IFFT

        subgraph PF_DETECT["Subpixel Peak Detection"]
            PF_LOCALMAX["<b>Local Maximum Filter</b><br/>Adaptive footprint from d-spacing"]
            PF_THRESH["Background Subtraction<br/>(percentile filter + prominence)"]
            PF_SUBPX["Parabolic Subpixel Refinement"]
        end

        PF_IFFT --> PF_LOCALMAX --> PF_THRESH --> PF_SUBPX

        subgraph PF_LATTICE["Lattice Validation"]
            PF_KDTREE["KDTree Nearest-Neighbor<br/>Distance Computation"]
            PF_VALID["Fraction Valid<br/>|NN_dist - expected_d| / expected_d <= tol<br/><i>Adaptive tolerance from IQR<br/>when >= 10 peaks</i>"]
            PF_G12{{"Gate G12: Lattice Consistency<br/>fraction_valid >= 50%<br/><b>DEGRADE on failure</b>"}}
        end

        PF_SUBPX --> PF_KDTREE --> PF_VALID --> PF_G12
    end

    subgraph VALIDATION["9/9 VALIDATION + REPORTING"]
        direction TB
        VAL_GATES["Aggregate All Gates<br/>(G1-G12 results)"]
        VAL_METRICS["Collect Diagnostics<br/>(preproc confidence, ROI coverage,<br/>FWHM distribution, orientation std)"]
        VAL_PASS["Overall Pass/Fail<br/>(FATAL gates only: G1, G5)"]
        VAL_GATES --> VAL_METRICS --> VAL_PASS
    end

    subgraph OUTPUT["Output Artifacts (25 files)"]
        direction TB

        subgraph OUT_DATA["Data Artifacts (8 files)"]
            direction TB

            subgraph OUT_JSON["JSON"]
                direction LR
                ART_PARAMS[("parameters.json<br/><i>v3.0: all config, preproc,<br/>ROI, FFT, tier, GPA,<br/>peak, gate results,<br/>low_q_exclusion</i>")]
                ART_REPORT[("report.json<br/><i>gates, pass/fail, summary,<br/>timestamp, diagnostics</i>")]
                ART_GVEC[("global_g_vectors.json<br/><i>frequency_unit + gx,gy<br/>per g-vector</i>")]
                ART_PEAKSTATS[("peak_stats.json<br/><i>fraction_valid, mean/std<br/>NN distance, n_peaks</i>")]
                ART_GPA_MODE[("gpa_mode_decision.json<br/><i>selected mode, metrics,<br/>confidence, reason</i>")]
                ART_GPA_REF[("gpa_reference.json<br/><i>center tile, bbox, orient<br/>mean/std, SNR, entropy</i>")]
            end

            subgraph OUT_NPY["NumPy Binary"]
                direction LR
                ART_TIER[("tier_map.npy<br/><i>uint8 (n_rows, n_cols)<br/>0=skip, 1=reject, 2=B, 3=A</i>")]
                ART_PEAKS[("lattice_peaks.npy<br/><i>float64 (N, 5)<br/>x, y, intensity, sigma_x, sigma_y</i>")]
            end
        end

        subgraph OUT_VIZ["PNG Visualizations (24 files, --no-viz to skip, --viz-dpi to set resolution)"]
            direction TB

            subgraph VIZ_ROW1["Input + Global FFT (3 files)"]
                direction LR
                VIZ_ORIG[("input_original.png<br/><i>Grayscale image<br/>with calibrated scale bar</i>")]
                VIZ_RADIAL[("globalfft_radial_profile.png<br/><i>q vs log-intensity<br/>background fit curve<br/>peak markers + d-spacing labels<br/>gray shaded q < q_min region</i>")]
                VIZ_POWER[("globalfft_power_spectrum.png<br/><i>Log |FFT|^2, inferno cmap<br/>cyan arrows for g-vectors<br/>d-spacing annotations<br/>dashed circle at q_min</i>")]
            end

            subgraph VIZ_ROW2["Tile Classification Maps (3 files)"]
                direction LR
                VIZ_TIERMAP[("tiles_tier_map.png<br/><i>Discrete colormap<br/>green=A, yellow=B<br/>red=rejected, gray=skipped<br/>legend with counts</i>")]
                VIZ_SNRMAP[("tiles_snr_map.png<br/><i>Viridis heatmap<br/>colorbar: Peak SNR<br/>masked where skipped</i>")]
                VIZ_ORIENTMAP[("tiles_orientation_map.png<br/><i>HSV cyclic cmap 0-180 deg<br/>masked where skipped<br/>or rejected</i>")]
            end

            subgraph VIZ_ROW3["GPA Phase + Amplitude (2x per g-vector)"]
                direction LR
                VIZ_PHASE0[("gpa_phase_g0.png<br/><i>Unwrapped phase (rad)<br/>twilight cmap<br/>NaN regions = gray</i>")]
                VIZ_PHASE1[("gpa_phase_g1.png<br/><i>Unwrapped phase (rad)<br/>twilight cmap<br/>NaN regions = gray</i>")]
                VIZ_AMP0[("gpa_amplitude_g0.png<br/><i>Amplitude, inferno cmap<br/>cyan contour at<br/>mask boundary</i>")]
                VIZ_AMP1[("gpa_amplitude_g1.png<br/><i>Amplitude, inferno cmap<br/>cyan contour at<br/>mask boundary</i>")]
            end

            subgraph VIZ_ROW4["GPA Displacement (2 files)"]
                direction LR
                VIZ_UX[("gpa_displacement_ux.png<br/><i>X displacement (nm)<br/>RdBu_r centred at 0<br/>colorbar in nm</i>")]
                VIZ_UY[("gpa_displacement_uy.png<br/><i>Y displacement (nm)<br/>RdBu_r centred at 0<br/>colorbar in nm</i>")]
            end

            subgraph VIZ_ROW5["GPA Strain (4 files)"]
                direction LR
                VIZ_EXX[("gpa_strain_exx.png<br/><i>Extensional strain x<br/>RdBu_r, +/-5%</i>")]
                VIZ_EYY[("gpa_strain_eyy.png<br/><i>Extensional strain y<br/>RdBu_r, +/-5%</i>")]
                VIZ_EXY[("gpa_strain_exy.png<br/><i>Shear strain<br/>RdBu_r, +/-5%</i>")]
                VIZ_ROT[("gpa_strain_rotation.png<br/><i>Rotation (deg)<br/>RdBu_r, +/-5 deg</i>")]
            end

            subgraph VIZ_ROW6["Peak Finding (1 file)"]
                direction LR
                VIZ_LATTICE[("peaks_lattice_overlay.png<br/><i>Bandpass image + cyan peaks<br/>NN connections:<br/>lime=valid, red=invalid</i>")]
            end

            subgraph VIZ_ROW7["Diagnostics (7 files)"]
                direction LR
                VIZ_ROI[("roi_mask_overlay.png<br/><i>Raw image + ROI contour<br/>LCC highlighted</i>")]
                VIZ_BGRESID[("globalfft_background_residual.png<br/><i>q vs residual<br/>q_fit_min marked</i>")]
                VIZ_REFBND[("tiles_reference_boundary.png<br/><i>Tier map + reference<br/>region contour</i>")]
                VIZ_EXEMPLAR[("tiles_exemplar_ffts.png<br/><i>3×2 grid of representative<br/>tile power spectra</i>")]
                VIZ_PHASENOISE[("gpa_phase_noise_histogram.png<br/><i>Phase distribution<br/>in reference region</i>")]
                VIZ_STRAINOUT[("gpa_strain_outlier_map.png<br/><i>Binary overlay of<br/>strain outlier pixels</i>")]
                VIZ_NNHIST[("peaks_nn_distance_histogram.png<br/><i>NN distance distribution<br/>expected-d line + tol band</i>")]
            end
        end
    end

    %% ============================================================
    %% MAIN FLOW CONNECTIONS
    %% ============================================================

    INPUT --> PREPROCESS
    PREPROCESS -->|"Branch A<br/>(float64, no blur)"| GLOBAL_FFT
    PREPROCESS -->|"Branch A"| TILE_FFT
    PREPROCESS -->|"Branch A"| GPA
    PREPROCESS -->|"Branch A"| PEAKFIND
    PREPROCESS -->|"Branch B<br/>(float32, blurred)"| ROI

    ROI -->|"tile grid mask"| TILE_FFT

    GLOBAL_FFT -->|"d_dom, q_ranges,<br/>g_vectors"| TILE_FFT
    GLOBAL_FFT -->|"g_vectors"| GPA
    GLOBAL_FFT -->|"d_dom, |g_dom|"| PEAKFIND

    TILE_FFT -->|"GatedTileGrid<br/>(tier/SNR/orientation maps)"| GPA
    TILE_FFT -->|"GatedTileGrid"| VALIDATION

    GPA -->|"GPAResult<br/>(phases, strain)"| VALIDATION
    PEAKFIND -->|"peaks, LatticeValidation"| VALIDATION

    VALIDATION --> OUTPUT

    %% ============================================================
    %% ARTIFACT PROVENANCE (which stage produces which artifact)
    %% ============================================================

    INPUT -->|"raw image"| VIZ_ORIG
    GLOBAL_FFT -->|"radial_profile,<br/>q_values, background,<br/>peaks"| VIZ_RADIAL
    GLOBAL_FFT -->|"power_spectrum,<br/>g_vectors"| VIZ_POWER
    GLOBAL_FFT -->|"g_vectors"| ART_GVEC

    TILE_FFT -->|"tier_map"| ART_TIER
    TILE_FFT -->|"tier_map"| VIZ_TIERMAP
    TILE_FFT -->|"snr_map"| VIZ_SNRMAP
    TILE_FFT -->|"orientation_map"| VIZ_ORIENTMAP

    GPA -->|"phases"| VIZ_PHASE0
    GPA -->|"phases"| VIZ_PHASE1
    GPA -->|"amplitude,<br/>amplitude_mask"| VIZ_AMP0
    GPA -->|"amplitude,<br/>amplitude_mask"| VIZ_AMP1
    GPA -->|"displacement.ux"| VIZ_UX
    GPA -->|"displacement.uy"| VIZ_UY
    GPA -->|"strain.exx"| VIZ_EXX
    GPA -->|"strain.eyy"| VIZ_EYY
    GPA -->|"strain.exy"| VIZ_EXY
    GPA -->|"strain.rotation"| VIZ_ROT
    GPA -->|"mode_decision"| ART_GPA_MODE
    GPA -->|"reference_region"| ART_GPA_REF

    PEAKFIND -->|"peaks"| ART_PEAKS
    PEAKFIND -->|"lattice_validation"| ART_PEAKSTATS
    PEAKFIND -->|"peaks + bandpass_image<br/>+ lattice_validation"| VIZ_LATTICE

    ROI -->|"mask + diagnostics"| VIZ_ROI
    GLOBAL_FFT -->|"background residual"| VIZ_BGRESID
    TILE_FFT -->|"tier_map + ref region"| VIZ_REFBND
    TILE_FFT -->|"tile power spectra"| VIZ_EXEMPLAR
    GPA -->|"phase in ref region"| VIZ_PHASENOISE
    GPA -->|"strain outliers"| VIZ_STRAINOUT
    PEAKFIND -->|"NN distances"| VIZ_NNHIST

    VALIDATION -->|"config + all results"| ART_PARAMS
    VALIDATION -->|"gates, summary"| ART_REPORT

    %% ============================================================
    %% STYLING
    %% ============================================================

    %% Noise filter / signal processing nodes (orange)
    classDef filterNode fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#e65100
    class IN_QMIN,IN_PHYSICS,PA_HOT,PA_CLIP,PA_NORM,PB_CLIP,PB_NORM,PB_GAUSS filterNode
    class ROI_INT,ROI_VAR,ROI_FILL,ROI_OPEN,ROI_SMOOTH,ROI_GRAD filterNode
    class GF_HANN,GF_RADIAL,GF_POLY,GF_NOISE,GF_SAVGOL filterNode
    class TF_HANN,TF_DC,TF_LOCALMAX,TF_SNR,TF_FWHM,TF_ORIENT filterNode
    class GPA_GMASK,GPA_DEMOD,GPA_UNWRAP,GPA_AMPMASK,GPA_SMOOTH,GF_GUIDANCE,GF_DIAG filterNode
    class PF_RING,PF_LOCALMAX,PF_THRESH filterNode

    %% Gate nodes (purple/red)
    classDef gateNode fill:#fce4ec,stroke:#c62828,stroke-width:2px,color:#b71c1c
    class IN_G0,IN_G1,PA_G2,ROI_G3,GF_G4,TF_G5,TF_G6,TF_G7,TF_G8 gateNode
    class GPA_ENTRY,GPA_G9,GPA_G10,GPA_G11,PF_G12 gateNode

    %% Data artifact nodes (green)
    classDef artifactNode fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    class ART_PARAMS,ART_REPORT,ART_GVEC,ART_TIER artifactNode
    class ART_GPA_MODE,ART_GPA_REF,ART_PEAKS,ART_PEAKSTATS artifactNode

    %% PNG visualization nodes (teal)
    classDef vizNode fill:#e0f7fa,stroke:#00695c,stroke-width:2px,color:#004d40
    class VIZ_ORIG,VIZ_RADIAL,VIZ_POWER vizNode
    class VIZ_TIERMAP,VIZ_SNRMAP,VIZ_ORIENTMAP vizNode
    class VIZ_PHASE0,VIZ_PHASE1,VIZ_AMP0,VIZ_AMP1 vizNode
    class VIZ_UX,VIZ_UY vizNode
    class VIZ_EXX,VIZ_EYY,VIZ_EXY,VIZ_ROT vizNode
    class VIZ_LATTICE vizNode
    class VIZ_ROI,VIZ_BGRESID,VIZ_REFBND,VIZ_EXEMPLAR vizNode
    class VIZ_PHASENOISE,VIZ_STRAINOUT,VIZ_NNHIST vizNode

    %% Stage subgraph styling
    classDef stageSubgraph fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    class INPUT,PREPROCESS,ROI,GLOBAL_FFT,TILE_FFT,GPA,PEAKFIND,VALIDATION stageSubgraph

    %% Artifact subgraph styling
    classDef artifactSubgraph fill:#f1f8e9,stroke:#558b2f,stroke-width:1px,stroke-dasharray: 5 5
    class OUTPUT artifactSubgraph
